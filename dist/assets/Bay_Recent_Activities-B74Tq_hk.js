import{_ as Z,J as ee,D as ae,r,c as m,o as te,z as se,a8 as le,a as _,b as h,d as a,e as l,u as o,h as b,t as B,a9 as oe,w as v,g,F as H,l as W,E as ie,f as ne,$ as P,O as I,P as ce,Q as j,m as w}from"./index-COfldkwK.js";import{q as de,r as re}from"./locker-B9bkZgAW.js";import"./index-B9ygI19o.js";const ve={class:"bay-page"},ue={class:"page-header"},ye={class:"page-title"},be={class:"content-container"},fe={class:"activate-section"},pe={class:"switch-save-group"},me={class:"deactivation-group"},_e={class:"detail-group"},he={class:"action-section"},ge={class:"action-btns"},we={class:"history-section"},Be={class:"history-header"},ke={class:"file-buttons"},xe={class:"table-wrapper"},Re={class:"activity-cards mobile-cards"},Ne={class:"card-row data-row"},Ce={class:"card-cell"},Se={class:"cell-value"},Ee={class:"card-cell"},Ie={class:"cell-value"},Ae={class:"card-row data-row"},De={class:"card-cell"},Ve={class:"cell-value"},qe={class:"card-cell"},Fe={class:"cell-value"},Te={__name:"Bay_Recent_Activities",setup(Ue){const T=ee(),c=ae(),J=r(null),U=r(null),A=m(()=>c.query.bayNumber||"Unknown"),D=m(()=>parseInt(c.query.lockerId)||1),V=m(()=>c.query.cabinetNo||c.query.bayNumber||1),$=m(()=>parseInt(c.query.cabinetState)||0);m(()=>c.query.cabinetName||"");const k=m(()=>c.query.deactivatedReason||""),u=r(!1),x=r(""),f=r(""),q=r(!1),L=[{label:"Not Needed",value:"not_needed"},{label:"Device Malfunction",value:"device_malfunction"},{label:"Bay Malfunction",value:"bay_malfunction"}],d=r([]),R=r(!1),O=async()=>{R.value=!0;try{const t={locker_id:D.value,bay:parseInt(V.value)||parseInt(A.value)||1};console.log("获取Bay历史记录, 参数:",t);const e=await de(t);if(console.log("Bay历史记录响应:",e.data),e.data.ret!==0||e.data.code!==200&&e.data.code!=="200")throw new Error(e.data.msg||"Failed to fetch bay history");let n=[];if(typeof e.data.ret_data=="string")try{n=JSON.parse(e.data.ret_data)}catch(i){console.error("解析 ret_data 失败:",i),n=[]}else n=e.data.ret_data||[];console.log("解析后的历史数据:",n),d.value=n.map(i=>({time:i.date_str||"",status:i.status_name||"",device:i.devices_name||"",bay:`Bay ${i.cabinet_no||A.value}`})),console.log("映射后的activityList:",d.value),d.value.length>0?w.success("Bay history loaded successfully"):w.info("No history records found")}catch(t){console.error("获取Bay历史记录失败:",t),w.error("Failed to load bay history: "+(t.message||"Unknown error")),d.value=[]}finally{R.value=!1}};te(()=>{if(u.value=$.value!==2,k.value){f.value=k.value;const t=L.find(e=>k.value.toLowerCase().includes(e.value.replace("_"," ")));t&&(x.value=t.value)}console.log("Bay详情页初始化:",{bayNumber:A.value,lockerId:D.value,cabinetNo:V.value,cabinetState:$.value,isBayActive:u.value,deactivatedReason:k.value}),O()});const z=t=>{console.log("Bay Activate 状态变化:",t),t&&(x.value="",f.value="")},Q=async()=>{try{if(!u.value&&!f.value.trim()){w.warning("Please enter the deactivation reason");return}q.value=!0;const t={locker_id:D.value,bay:parseInt(V.value),status:u.value?1:2,cabinet_deactivated_reason:u.value?"":f.value.trim()};console.log("调用 edit_bay 接口，参数:",t);const e=await re(t);if(console.log("edit_bay 接口响应:",e.data),e.data.ret===0&&(e.data.code===200||e.data.code==="200"))w.success("Bay information saved successfully"),await O();else throw new Error(e.data.msg||"Failed to save bay information")}catch(t){console.error("保存Bay信息失败:",t),w.error("Failed to save: "+(t.message||"Unknown error"))}finally{q.value=!1}},G=()=>{window.history.length>1?T.back():T.push("/Bay_Management")},K=()=>{var t;(t=U.value)==null||t.click()},X=async t=>{const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=i=>{var s,p,y,M;try{const F=i.target.result;if(e.name.endsWith(".csv")){const N=F.split(`
`),$e=N[0].split(","),C=[];for(let S=1;S<N.length;S++)if(N[S].trim()){const E=N[S].split(",");C.push({time:((s=E[0])==null?void 0:s.trim())||"",status:((p=E[1])==null?void 0:p.trim())||"",device:((y=E[2])==null?void 0:y.trim())||"",bay:((M=E[3])==null?void 0:M.trim())||""})}C.length>0&&(d.value=C,alert(`Successfully imported ${C.length} activity records`))}else(e.name.endsWith(".xlsx")||e.name.endsWith(".xls"))&&alert("Excel file import requires xlsx library. Please use CSV format or install xlsx library.")}catch(F){console.error("Import failed:",F),alert("File import failed, please check the file format")}},n.readAsText(e),t.target.value=""},Y=()=>{const t=["Time,Status,Device,Bay"],e=d.value.map(y=>`${y.time},${y.status},${y.device},${y.bay}`),n=[t,...e].join(`
`),i=new Blob([n],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),p=URL.createObjectURL(i);s.setAttribute("href",p),s.setAttribute("download",`Bay_${c.query.bayNumber||"Unknown"}_Activity_${new Date().getTime()}.csv`),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),alert("Activity records exported successfully")};return(t,e)=>{const n=se("el-input"),i=le("loading");return h(),_("div",ve,[a("div",ue,[l(o(b),{type:"default",icon:"ArrowLeft",class:"back-btn",onClick:G}),a("h2",ye," Bay "+B(t.$route.query.bayNumber||"Unknown")+" - Recent Activities ",1)]),a("div",be,[a("div",fe,[a("div",pe,[e[4]||(e[4]=a("span",null,"Bay Activate",-1)),l(o(oe),{modelValue:u.value,"onUpdate:modelValue":e[0]||(e[0]=s=>u.value=s),onChange:z},null,8,["modelValue"]),l(o(b),{class:"save-btn",onClick:Q,loading:q.value},{default:v(()=>[...e[3]||(e[3]=[g("Save",-1)])]),_:1},8,["loading"])]),a("div",me,[e[5]||(e[5]=a("span",null,"Deactivation reason",-1)),l(o(ne),{modelValue:x.value,"onUpdate:modelValue":e[1]||(e[1]=s=>x.value=s),placeholder:"Select Reason"},{default:v(()=>[(h(),_(H,null,W(L,s=>l(o(ie),{key:s.value,label:s.label,value:s.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),a("div",_e,[e[6]||(e[6]=a("span",null,"Detail *",-1)),l(n,{modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=s=>f.value=s),type:"textarea",rows:3,placeholder:"Enter detail description",class:"detail-textarea"},null,8,["modelValue"])])]),a("div",he,[e[10]||(e[10]=a("p",null,"What do you want to do?",-1)),a("div",ge,[l(o(b),{class:"open-bay-btn"},{default:v(()=>[...e[7]||(e[7]=[g("Open Bay",-1)])]),_:1}),l(o(b),{class:"check-btn"},{default:v(()=>[...e[8]||(e[8]=[g("Check-Out",-1)])]),_:1}),l(o(b),{class:"check-btn"},{default:v(()=>[...e[9]||(e[9]=[g("Check-In",-1)])]),_:1})])]),a("div",we,[a("div",Be,[e[13]||(e[13]=a("h3",null,"Recent Bay Activity History",-1)),a("div",ke,[l(o(b),{class:"import-btn",onClick:K},{default:v(()=>[...e[11]||(e[11]=[g("Import File",-1)])]),_:1}),a("input",{ref_key:"fileInput",ref:U,type:"file",accept:".csv,.xlsx,.xls",style:{display:"none"},onChange:X},null,544),l(o(b),{class:"export-btn",onClick:Y},{default:v(()=>[...e[12]||(e[12]=[g("Export File",-1)])]),_:1})])]),P((h(),_("div",xe,[l(o(ce),{ref_key:"activityTableRef",ref:J,data:d.value,style:{width:"100%"},class:"desktop-table"},{default:v(()=>[l(o(I),{prop:"time",label:"Time",align:"left"}),l(o(I),{prop:"status",label:"Status",align:"left"}),l(o(I),{prop:"device",label:"Device",align:"left"}),l(o(I),{prop:"bay",label:"Bay",align:"left"})]),_:1},8,["data"])])),[[i,R.value]]),P((h(),_("div",Re,[(h(!0),_(H,null,W(d.value,(s,p)=>(h(),_("div",{key:p,class:"activity-card"},[e[16]||(e[16]=j('<div class="card-row header-row-card" data-v-fdc9b2ec><div class="card-cell" data-v-fdc9b2ec><div class="cell-label" data-v-fdc9b2ec>Time</div></div><div class="card-divider-vertical" data-v-fdc9b2ec></div><div class="card-cell" data-v-fdc9b2ec><div class="cell-label" data-v-fdc9b2ec>Status</div></div></div>',1)),a("div",Ne,[a("div",Ce,[a("div",Se,B(s.time),1)]),e[14]||(e[14]=a("div",{class:"card-divider-vertical"},null,-1)),a("div",Ee,[a("div",Ie,B(s.status),1)])]),e[17]||(e[17]=j('<div class="card-row header-row-card" data-v-fdc9b2ec><div class="card-cell" data-v-fdc9b2ec><div class="cell-label" data-v-fdc9b2ec>Device</div></div><div class="card-divider-vertical" data-v-fdc9b2ec></div><div class="card-cell" data-v-fdc9b2ec><div class="cell-label" data-v-fdc9b2ec>Bay</div></div></div>',1)),a("div",Ae,[a("div",De,[a("div",Ve,B(s.device),1)]),e[15]||(e[15]=a("div",{class:"card-divider-vertical"},null,-1)),a("div",qe,[a("div",Fe,B(s.bay),1)])])]))),128))])),[[i,R.value]])])])])}}},He=Z(Te,[["__scopeId","data-v-fdc9b2ec"]]);export{He as default};
