import{q as W,r as m,c as E,o as X,v as Y,aa as Z,a as d,d as n,e as f,w as b,u as r,i as ee,K as se,h as x,g as P,ab as B,y as L,F as C,l as M,f as le,$ as ae,a8 as oe,ac as te,J as ne,m as v,b as c,G as F,E as ce,t as z,_ as re}from"./index-COfldkwK.js";import{f as ie,h as de,i as ue}from"./account-QIE51ytO.js";import"./index-B9ygI19o.js";const me={class:"permissions-page"},fe={class:"permissions-title-row"},ve={class:"permissions-header"},pe={class:"header-right"},ge={class:"select-all"},he={class:"permissions-content-wrapper"},be={class:"permissions-sidebar"},ke={class:"role-selector"},_e={key:0,class:"save-section"},ye={key:1,class:"role-note"},Ie={class:"permissions-content"},Ae={class:"permissions-grid"},Ve={class:"permission-name"},Re={class:"permission-options"},we={class:"permission-all"},Ee=W({name:"Permissions",__name:"Permissions",setup(Pe){const O=ne(),T=()=>{O.back()};let N=!1;const A=m(!1),V=m(!1),p=m([]),u=m(null),_=m(!1),R=m([]),w=()=>{const e=localStorage.getItem("userInfo");if(e)try{return JSON.parse(e)}catch(s){return console.error("解析用户信息失败:",s),null}return null},S=E(()=>{const e=w();return(e==null?void 0:e.role_id)||(e==null?void 0:e.type)||null}),y={1:[1,2,3],2:[2,3],3:[3]},I={super_admin:["Admin","Manager","Supervisor"],admin:["Manager","Supervisor"],manager:["Supervisor"],supervisor:[]},j=E(()=>{var o;const e=w(),s=((o=e==null?void 0:e.account)==null?void 0:o.toLowerCase())||"",a=S.value;if(console.log("当前用户信息:",e),console.log("当前用户账户:",s),console.log("当前用户角色ID:",a),console.log("所有角色:",p.value),s==="super_admin"){const t=I.super_admin;return p.value.filter(i=>t.includes(i.label))}if(a!==null&&y[a]){const t=y[a];return console.log("可管理的角色ID列表:",t),p.value.filter(i=>t.includes(i.value))}const l=I[s]||[];return console.log("可管理的角色名称列表:",l),p.value.filter(t=>l.includes(t.label))}),g=E(()=>{var i;const e=w(),s=((i=e==null?void 0:e.account)==null?void 0:i.toLowerCase())||"",a=S.value,l=u.value;if(l===null)return!1;const o=p.value.find(k=>k.value===l);return o?s==="super_admin"?I.super_admin.includes(o.label):a!==null&&y[a]?y[a].includes(l):(I[s]||[]).includes(o.label):!1}),h=m([{name:"Notifications",options:[{label:"View Page",checked:!1,menuId:101},{label:"Manage Notifications",checked:!1,menuId:102}],selectAll:!1},{name:"Lockers",options:[{label:"View Page",checked:!1,menuId:201},{label:"Manage Lockers",checked:!1,menuId:202}],selectAll:!1},{name:"Devices",options:[{label:"View Page",checked:!1,menuId:301},{label:"Manage Devices",checked:!1,menuId:302}],selectAll:!1},{name:"Device Types",options:[{label:"View Page",checked:!1,menuId:401},{label:"Manage Types",checked:!1,menuId:402}],selectAll:!1},{name:"Departments",options:[{label:"View Page",checked:!1,menuId:501},{label:"Manage Departments",checked:!1,menuId:502}],selectAll:!1},{name:"Users",options:[{label:"View Page",checked:!1,menuId:601},{label:"Manage Users",checked:!1,menuId:602}],selectAll:!1},{name:"Bay Management",options:[{label:"View All Bays",checked:!1,menuId:701},{label:"Create Bay",checked:!1,menuId:702},{label:"Edit Bay",checked:!1,menuId:703},{label:"Archive Bay & Reset",checked:!1,menuId:704},{label:"Delete Bay",checked:!1,menuId:705}],selectAll:!1},{name:"Reports",options:[{label:"View Page",checked:!1,menuId:801},{label:"Export Reports",checked:!1,menuId:802}],selectAll:!1},{name:"Account",options:[{label:"View Page",checked:!1,menuId:901},{label:"Manage Account",checked:!1,menuId:902}],selectAll:!1}]),H=async()=>{try{const e=await ie();e.data.ret===0&&e.data.ret_data?p.value=e.data.ret_data.map(s=>({label:s.name,value:s.id})):(console.error("Failed to fetch role list:",e.data.msg),v.error("Failed to fetch role list"))}catch(e){console.error("Error fetching role list:",e),v.error("Error fetching role list")}},J=async e=>{A.value=!0;try{const s=await ue(e);if(s.data.ret===0&&s.data.ret_data){const a=s.data.ret_data,l=a.ids?a.ids.split(",").map(o=>parseInt(o.trim())).filter(o=>!isNaN(o)):[];R.value=l,h.value.forEach(o=>{o.options.forEach(t=>{t.checked=l.includes(t.menuId)}),o.selectAll=o.options.every(t=>t.checked)}),D()}else console.error("Failed to fetch role permissions:",s.data.msg),v.error("Failed to fetch role permissions")}catch(s){console.error("Error fetching role permissions:",s),v.error("Error fetching role permissions")}finally{A.value=!1}},q=async()=>{if(!(u.value===null||!g.value)){V.value=!0;try{const e=[];h.value.forEach(l=>{l.options.forEach(o=>{o.checked&&e.push(o.menuId)})});const s={id:u.value,menu_ids:e.join(",")},a=await de(s);a.data.ret===0?(v.success("Permissions saved successfully"),R.value=e):v.error(a.data.msg||"Failed to save permissions")}catch(e){console.error("Error saving permissions:",e),v.error("Error saving permissions")}finally{V.value=!1}}},G=e=>{e!==null?J(e):K()},K=()=>{h.value.forEach(e=>{e.selectAll=!1,e.options.forEach(s=>{s.checked=!1})}),_.value=!1,R.value=[]},D=()=>{_.value=h.value.every(e=>e.options.every(s=>s.checked))},U=async()=>{console.log("Permissions page initializing...");try{await te(),await H(),N=!0,console.log("Permissions page initialized successfully")}catch(e){console.error("Error initializing Permissions:",e)}};X(async()=>{console.log("Permissions onMounted - component mounted"),await U()}),Y(async()=>{console.log("Permissions onActivated - component activated from cache"),await U()}),Z(()=>{console.log("Permissions onBeforeUnmount - component unmounting"),N=!1});const $=e=>{const s=typeof e=="boolean"?e:!!e;h.value.forEach(a=>{a.selectAll=s,a.options.forEach(l=>{l.checked=s})})},Q=e=>{e.options.forEach(s=>{s.checked=e.selectAll}),D()};return(e,s)=>{const a=oe("loading");return c(),d("div",me,[n("div",fe,[f(r(x),{type:"text",class:"back-button-new",onClick:T},{default:b(()=>[f(r(ee),null,{default:b(()=>[f(r(se))]),_:1})]),_:1}),s[2]||(s[2]=n("h1",{class:"permissions-title"},"Permissions",-1))]),n("div",ve,[s[4]||(s[4]=n("div",{class:"header-tabs"},[n("div",{class:"tab-item active"},"Operation")],-1)),s[5]||(s[5]=n("div",{class:"assign-label"},"Assign",-1)),n("div",pe,[n("div",ge,[f(r(B),{modelValue:_.value,"onUpdate:modelValue":s[0]||(s[0]=l=>_.value=l),onChange:$,disabled:!g.value},{default:b(()=>[...s[3]||(s[3]=[P("Select All",-1)])]),_:1},8,["modelValue","disabled"])])])]),n("div",he,[n("div",be,[n("div",ke,[f(r(le),{modelValue:u.value,"onUpdate:modelValue":s[1]||(s[1]=l=>u.value=l),placeholder:"Please select role",class:"role-select",onChange:G},{default:b(()=>[(c(!0),d(C,null,M(j.value,l=>(c(),F(r(ce),{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),u.value!==null&&g.value?(c(),d("div",_e,[f(r(x),{type:"primary",class:"save-btn",onClick:q,loading:V.value},{default:b(()=>[...s[6]||(s[6]=[P(" Save ",-1)])]),_:1},8,["loading"])])):L("",!0),u.value!==null&&!g.value?(c(),d("div",ye,[...s[7]||(s[7]=[n("span",{class:"note-text"},"Super Admin permissions cannot be edited",-1)])])):L("",!0)]),n("div",Ie,[ae((c(),d("div",Ae,[(c(!0),d(C,null,M(h.value,(l,o)=>(c(),d("div",{key:o,class:"permission-row"},[n("div",Ve,z(l.name),1),n("div",Re,[(c(!0),d(C,null,M(l.options,(t,i)=>(c(),F(r(B),{key:i,modelValue:t.checked,"onUpdate:modelValue":k=>t.checked=k,class:"permission-checkbox",disabled:!g.value},{default:b(()=>[P(z(t.label),1)]),_:2},1032,["modelValue","onUpdate:modelValue","disabled"]))),128))]),n("div",we,[f(r(B),{modelValue:l.selectAll,"onUpdate:modelValue":t=>l.selectAll=t,onChange:()=>Q(l),disabled:!g.value},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"])])]))),128))])),[[a,A.value]])])])])}}}),Ne=re(Ee,[["__scopeId","data-v-cf8f9ac7"]]);export{Ne as default};
