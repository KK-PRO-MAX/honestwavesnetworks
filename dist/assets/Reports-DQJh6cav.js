import{a as f}from"./index-B9ygI19o.js";import{g as b}from"./user-DZDS1ZP8.js";import{g as _}from"./device-p3qppuv_.js";import{g as w}from"./locker-B9bkZgAW.js";import{_ as C,a as d,b as r,d as t,y as g,g as m,n as D,$ as M,t as c,a3 as L,F as u,l as h,Q as k}from"./index-COfldkwK.js";const p=f.create({baseURL:"https://guiz.haomengwl.com/api",timeout:1e4,headers:{"Content-Type":"application/json"}});p.interceptors.request.use(s=>{var a;const e=localStorage.getItem("token");return e&&(s.headers.token=e),console.log("Report API 发送请求:",(a=s.method)==null?void 0:a.toUpperCase(),s.url),console.log("请求数据:",s.data),s},s=>(console.error("请求拦截器错误:",s),Promise.reject(s)));p.interceptors.response.use(s=>(console.log("Report API 收到响应:",s.status,s.data),s.data&&typeof s.data=="object"&&(s.data.ret!==void 0&&console.log("  ✓ ret:",s.data.ret),s.data.code!==void 0&&console.log("  ✓ code:",s.data.code),s.data.msg!==void 0&&console.log("  ✓ msg:",s.data.msg),s.data.ret_data!==void 0&&(console.log("  ✓ ret_data 类型:",Array.isArray(s.data.ret_data)?"Array":typeof s.data.ret_data),Array.isArray(s.data.ret_data)&&console.log("    数据数量:",s.data.ret_data.length))),s),s=>(console.error("Report API 响应错误:",s.message||s),s.response?(console.error("  HTTP 状态码:",s.response.status),console.error("  响应数据:",s.response.data)):s.request?console.error("  没有接收到响应"):console.error("  请求错误:",s.message),Promise.reject(s)));function S(s={}){return p.post("/Reports/getlist",s)}const R={data(){return{reportData:[],loading:!1,showDatePicker:!1,startDate:null,endDate:null,startDisplayMonth:new Date,endDisplayMonth:new Date,showEventOptions:!1,selectedEvent:"All",eventOptions:["Deactivated","Activated","Opened Bay","Check-In","Check-Out"],showUsersModal:!1,usersList:[],selectedUsers:[],showDevicesModal:!1,devicesList:[],selectedDevices:[],showLockersModal:!1,lockersList:[],selectedLockers:[],showBaysModal:!1,baysList:[],selectedBays:[]}},computed:{startDateFormatted(){return this.startDate?this.formatDate(this.startDate):""},endDateFormatted(){return this.endDate?this.formatDate(this.endDate):""},startMonthYear(){const s=this.startDisplayMonth.toLocaleString("en-US",{month:"long"}),e=this.startDisplayMonth.getFullYear();return`${s} ${e}`},endMonthYear(){const s=this.endDisplayMonth.toLocaleString("en-US",{month:"long"}),e=this.endDisplayMonth.getFullYear();return`${s} ${e}`},startDays(){return this.generateDays(this.startDisplayMonth)},endDays(){return this.generateDays(this.endDisplayMonth)}},async mounted(){document.addEventListener("click",s=>{const e=this.$el.querySelector(".event-selector");!e||e.contains(s.target)||(this.showEventOptions=!1)}),await this.loadDropdownData(),this.loadReportData()},methods:{async loadDropdownData(){try{const s=await b();s&&s.data&&s.data.ret===0&&(this.usersList=s.data.ret_data.map(i=>({id:i.id,name:`${i.user_first_name} ${i.user_last_name}`,badgeId:i.user_badge_id})));const e=await _();e&&e.data&&e.data.ret===0&&(this.devicesList=e.data.ret_data.map(i=>({id:i.id,name:i.device_name,deviceId:i.device_id})));const a=await w();a&&a.data&&a.data.ret===0&&(this.lockersList=a.data.ret_data.map(i=>({id:i.id,name:i.name,bayTotal:i.bay_total}))),this.baysList=[]}catch(s){console.error("加载下拉列表数据失败:",s)}},updateBaysList(){if(this.baysList=[],this.selectedLockers.length>0){const s=this.selectedLockers[0];if(s&&s.bayTotal)for(let e=1;e<=s.bayTotal;e++)this.baysList.push(e)}},toggleSelection(s,e){if(s===this.selectedLockers){if(s.some(a=>a.id===e.id)){const a=s.findIndex(i=>i.id===e.id);s.splice(a,1)}else s.splice(0,s.length),s.push(e);this.updateBaysList(),this.selectedBays=[]}else{const a=s.findIndex(i=>typeof i=="object"?i.id===e.id:i===e);a>-1?s.splice(a,1):s.push(e)}},async loadReportData(){this.loading=!0;try{const s={};if(this.selectedUsers.length>0){const a=this.selectedUsers[0].id;a&&(s.user_id=a)}if(this.selectedLockers.length>0){if(this.selectedDevices.length>0&&(s.devices_id=this.selectedDevices[0].deviceId),this.selectedLockers.length>0){const a=this.selectedLockers[0].id;a&&(s.locker_id=a)}if(this.selectedBays.length>0){const a=this.selectedBays[0];a&&(s.cabinet_no=a)}}if(this.selectedEvent!=="All"){const a={Deactivated:"0",Activated:"1","Opened Bay":"2","Check-In":"3","Check-Out":"4"};s.event=a[this.selectedEvent]||this.selectedEvent}if(this.startDate&&(s.start_time=Math.floor(this.startDate.getTime()/1e3)),this.endDate){const a=new Date(this.endDate);a.setHours(23,59,59,999),s.end_time=Math.floor(a.getTime()/1e3)}s.page=1,console.log("请求参数:",s);const e=await S(s);if(console.log("API 响应:",e),e&&e.data){const a=e.data;if(console.log("响应数据结构:",a),a.ret===0||a.code===200||a.code==="200"){let i=a.ret_data;if(typeof i=="string")try{i=JSON.parse(i)}catch(o){throw console.error("解析报告数据失败:",o),new Error("数据格式错误")}i&&Array.isArray(i)?(this.reportData=i,console.log("✓ 报告数据加载成功，共",this.reportData.length,"条记录")):(console.warn("⚠ API 返回格式异常，使用空数据"),this.reportData=[])}else throw new Error(a.msg||`API 错误：${a.code}`)}else throw new Error("无效的 API 响应")}catch(s){console.error("✗ 报告数据加载失败:",s),this.reportData=[]}finally{this.loading=!1}},formatDateTime(s,e){return!s||!e?"":`${s} - ${e}`},clearFilters(){this.selectedUsers=[],this.selectedDevices=[],this.selectedLockers=[],this.selectedBays=[],this.selectedEvent="All",this.startDate=null,this.endDate=null,this.loadReportData()},generateDays(s){const e=s.getFullYear(),a=s.getMonth(),i=new Date(e,a+1,0).getDate(),o=new Date(e,a,1).getDay(),n=[];for(let l=0;l<o;l++)n.push({date:null});for(let l=1;l<=i;l++)n.push({date:new Date(e,a,l)});return n},formatDate(s){const e=s.getMonth()+1,a=s.getDate(),i=s.getFullYear();return`${e.toString().padStart(2,"0")}/${a.toString().padStart(2,"0")}/${i}`},isSameDate(s,e){return!s||!e?!1:s.getFullYear()===e.getFullYear()&&s.getMonth()===e.getMonth()&&s.getDate()===e.getDate()},isDateInRange(s){return!this.startDate||!this.endDate?!1:s>=this.startDate&&s<=this.endDate},selectStartDate(s){this.startDate=new Date(s),this.endDate&&this.endDate<this.startDate&&(this.endDate=null)},selectEndDate(s){this.endDate=new Date(s)},prevMonth(s){s==="start"?this.startDisplayMonth=new Date(this.startDisplayMonth.getFullYear(),this.startDisplayMonth.getMonth()-1,1):this.endDisplayMonth=new Date(this.endDisplayMonth.getFullYear(),this.endDisplayMonth.getMonth()-1,1)},nextMonth(s){s==="start"?this.startDisplayMonth=new Date(this.startDisplayMonth.getFullYear(),this.startDisplayMonth.getMonth()+1,1):this.endDisplayMonth=new Date(this.endDisplayMonth.getFullYear(),this.endDisplayMonth.getMonth()+1,1)},resetDates(){this.startDate=null,this.endDate=null},confirmDates(){this.showDatePicker=!1,this.loadReportData()},toggleEventOptions(){this.showEventOptions=!this.showEventOptions},selectEvent(s){this.selectedEvent=s,this.showEventOptions=!1,this.loadReportData()},exportTableData(){let s=`Time,User,User Role,Device,Bay #,Event
`;this.reportData.forEach(l=>{const v=[this.escapeCsvField(this.formatDateTime(l.date_str,l.time_str)),this.escapeCsvField(l.user_name),this.escapeCsvField(l.user_role),this.escapeCsvField(l.devices_id.toString()),this.escapeCsvField(l.cabinet_no.toString()),this.escapeCsvField(l.event_name)];s+=v.join(",")+`
`});const e=new Blob([s],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(e),i=document.createElement("a");i.setAttribute("href",a);const n=new Date().toISOString().split("T")[0];i.setAttribute("download",`report_data_${n}.csv`),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)},escapeCsvField(s){return s?s.includes(",")||s.includes('"')||s.includes(`
`)||s.includes("\r")?`"${s.replace(/"/g,'""')}"`:s:""}}},E={class:"report-page"},U={class:"filter-section"},B={class:"filter-row first-row"},F={class:"filter-item"},A=["value"],T={class:"filter-item"},x=["value"],I={class:"filter-item"},O=["value","disabled"],P={class:"filter-item"},Y=["value","disabled"],j={class:"filter-row second-row"},N={class:"filter-item"},V={class:"event-selector"},q={class:"select-options"},z=["onClick"],H={class:"filter-item date-filter"},W=["value"],J=["value"],Q={key:0,class:"date-picker-popup"},G={class:"date-picker-header"},K={class:"date-picker-body"},X={class:"calendar"},Z={class:"calendar-header"},$={class:"days"},ee=["onClick"],te={class:"calendar"},se={class:"calendar-header"},le={class:"days"},oe=["onClick"],ae={class:"date-picker-footer"},ne={class:"filter-actions"},ie={ref:"reportTable",class:"report-table desktop-table"},de={class:"report-cards mobile-cards"},re={class:"card-row data-row"},ce={class:"card-cell"},ve={class:"cell-value"},ue={class:"card-cell"},he={class:"cell-value"},De={class:"card-cell"},ge={class:"cell-value"},pe={class:"card-row data-row"},me={class:"card-cell"},ke={class:"cell-value"},ye={class:"card-cell"},fe={class:"cell-value"},be={class:"card-cell"},_e={class:"cell-value"},we={key:0,class:"modal-overlay"},Ce={class:"modal"},Me={class:"modal-header"},Le={class:"modal-body grid-container"},Se=["onClick"],Re={class:"modal-footer"},Ee={key:1,class:"modal-overlay"},Ue={class:"modal"},Be={class:"modal-header"},Fe={class:"modal-body grid-container"},Ae=["onClick"],Te={class:"modal-footer"},xe={key:2,class:"modal-overlay"},Ie={class:"modal"},Oe={class:"modal-header"},Pe={class:"modal-body grid-container"},Ye=["onClick"],je={class:"modal-footer"},Ne={key:3,class:"modal-overlay"},Ve={class:"modal"},qe={class:"modal-header"},ze={key:0},He={key:1},We={class:"modal-body grid-container"},Je=["onClick"],Qe={class:"modal-footer"};function Ge(s,e,a,i,o,n){return r(),d("div",E,[e[51]||(e[51]=t("h1",null,"Reports",-1)),t("div",U,[t("div",B,[t("div",F,[e[29]||(e[29]=t("label",null,"Users",-1)),t("input",{type:"text",value:o.selectedUsers.length>0?o.selectedUsers.map(l=>l.name).join(", "):"All",readonly:"",class:"clickable-input",onClick:e[0]||(e[0]=l=>o.showUsersModal=!0)},null,8,A)]),t("div",T,[e[30]||(e[30]=t("label",null,"Lockers",-1)),t("input",{type:"text",value:o.selectedLockers.length>0?o.selectedLockers[0].name:"All",readonly:"",class:"clickable-input",onClick:e[1]||(e[1]=l=>o.showLockersModal=!0)},null,8,x)]),t("div",I,[e[31]||(e[31]=t("label",null,"Device",-1)),t("input",{type:"text",value:o.selectedLockers.length===0?"Please select a locker first":o.selectedDevices.length>0?o.selectedDevices.map(l=>l.name).join(", "):"All",readonly:"",class:D(["clickable-input",{"disabled-input":o.selectedLockers.length===0,"placeholder-style":o.selectedLockers.length===0}]),disabled:o.selectedLockers.length===0,onClick:e[2]||(e[2]=l=>o.selectedLockers.length>0&&(o.showDevicesModal=!0))},null,10,O)]),t("div",P,[e[32]||(e[32]=t("label",null,"Bay #",-1)),t("input",{type:"text",value:o.selectedLockers.length===0?"Please select a locker first":o.selectedBays.length>0?o.selectedBays.join(", "):"All",readonly:"",class:D(["clickable-input",{"disabled-input":o.selectedLockers.length===0,"placeholder-style":o.selectedLockers.length===0}]),disabled:o.selectedLockers.length===0,onClick:e[3]||(e[3]=l=>o.selectedLockers.length>0&&(o.showBaysModal=!0))},null,10,Y)])]),e[40]||(e[40]=m()),t("div",j,[t("div",N,[e[34]||(e[34]=t("label",null,"Event",-1)),t("div",V,[t("div",{class:"select-trigger",onClick:e[4]||(e[4]=(...l)=>n.toggleEventOptions&&n.toggleEventOptions(...l))},[m(c(o.selectedEvent)+" ",1),e[33]||(e[33]=t("i",{class:"dropdown-icon"},"▼",-1))]),M(t("div",q,[(r(!0),d(u,null,h(o.eventOptions,l=>(r(),d("div",{key:l,class:"option",onClick:v=>n.selectEvent(l)},c(l),9,z))),128))],512),[[L,o.showEventOptions]])])]),t("div",H,[e[38]||(e[38]=t("label",null,"Dates",-1)),t("input",{type:"text",value:n.startDateFormatted,placeholder:"Starting Date",readonly:"",class:"clickable-input",onClick:e[5]||(e[5]=l=>o.showDatePicker=!0)},null,8,W),e[39]||(e[39]=t("span",null,"to",-1)),t("input",{type:"text",value:n.endDateFormatted,placeholder:"Ending Date",readonly:"",class:"clickable-input",onClick:e[6]||(e[6]=l=>o.showDatePicker=!0)},null,8,J),o.showDatePicker?(r(),d("div",Q,[t("div",G,[t("button",{onClick:e[7]||(e[7]=l=>o.showDatePicker=!1)},"×"),e[35]||(e[35]=t("h3",null,"Select Date Range",-1))]),t("div",K,[t("div",X,[t("div",Z,[t("button",{onClick:e[8]||(e[8]=l=>n.prevMonth("start"))},"←"),t("h4",null,c(n.startMonthYear),1),t("button",{onClick:e[9]||(e[9]=l=>n.nextMonth("start"))},"→")]),e[36]||(e[36]=t("div",{class:"weekdays"},[t("div",null,"Sun"),t("div",null,"Mon"),t("div",null,"Tue"),t("div",null,"Wed"),t("div",null,"Thu"),t("div",null,"Fri"),t("div",null,"Sat")],-1)),t("div",$,[(r(!0),d(u,null,h(n.startDays,(l,v)=>(r(),d("div",{key:v,class:D(["day",{empty:!l.date,selected:l.date&&n.isSameDate(l.date,o.startDate),"in-range":l.date&&n.isDateInRange(l.date)}]),onClick:y=>l.date&&n.selectStartDate(l.date)},c(l.date?l.date.getDate():""),11,ee))),128))])]),t("div",te,[t("div",se,[t("button",{onClick:e[10]||(e[10]=l=>n.prevMonth("end"))},"←"),t("h4",null,c(n.endMonthYear),1),t("button",{onClick:e[11]||(e[11]=l=>n.nextMonth("end"))},"→")]),e[37]||(e[37]=t("div",{class:"weekdays"},[t("div",null,"Sun"),t("div",null,"Mon"),t("div",null,"Tue"),t("div",null,"Wed"),t("div",null,"Thu"),t("div",null,"Fri"),t("div",null,"Sat")],-1)),t("div",le,[(r(!0),d(u,null,h(n.endDays,(l,v)=>(r(),d("div",{key:v,class:D(["day",{empty:!l.date,selected:l.date&&n.isSameDate(l.date,o.endDate),"in-range":l.date&&n.isDateInRange(l.date),disabled:l.date&&l.date<o.startDate}]),onClick:y=>l.date&&l.date>=o.startDate&&n.selectEndDate(l.date)},c(l.date?l.date.getDate():""),11,oe))),128))])])]),t("div",ae,[t("button",{onClick:e[12]||(e[12]=(...l)=>n.resetDates&&n.resetDates(...l))},"Reset"),t("button",{onClick:e[13]||(e[13]=(...l)=>n.confirmDates&&n.confirmDates(...l))},"Apply")])])):g("",!0)])]),t("div",ne,[t("button",{class:"btn clear",onClick:e[14]||(e[14]=(...l)=>n.clearFilters&&n.clearFilters(...l))},"Clear Filters"),t("button",{class:"btn run",onClick:e[15]||(e[15]=(...l)=>n.loadReportData&&n.loadReportData(...l))},"Run Report"),t("span",{class:"export-data",onClick:e[16]||(e[16]=(...l)=>n.exportTableData&&n.exportTableData(...l))},"Export Data")])]),t("table",ie,[e[41]||(e[41]=t("thead",null,[t("tr",null,[t("th",null,"Time"),t("th",null,"User"),t("th",null,"User Role"),t("th",null,"Device"),t("th",null,"Bay #"),t("th",null,"Event")])],-1)),t("tbody",null,[(r(!0),d(u,null,h(o.reportData,l=>(r(),d("tr",{key:l.id},[t("td",null,c(n.formatDateTime(l.date_str,l.time_str)),1),t("td",null,c(l.user_name),1),t("td",null,c(l.user_role),1),t("td",null,c(l.devices_id),1),t("td",null,c(l.cabinet_no),1),t("td",null,c(l.event_name),1)]))),128))])],512),t("div",de,[(r(!0),d(u,null,h(o.reportData,(l,v)=>(r(),d("div",{key:v,class:"report-card"},[e[46]||(e[46]=k('<div class="card-row header-row-card" data-v-80936e85><div class="card-cell" data-v-80936e85><div class="cell-label" data-v-80936e85>Time</div></div><div class="card-divider-vertical" data-v-80936e85></div><div class="card-cell" data-v-80936e85><div class="cell-label" data-v-80936e85>User</div></div><div class="card-divider-vertical" data-v-80936e85></div><div class="card-cell" data-v-80936e85><div class="cell-label" data-v-80936e85>User Role</div></div></div>',1)),t("div",re,[t("div",ce,[t("div",ve,c(n.formatDateTime(l.date_str,l.time_str)),1)]),e[42]||(e[42]=t("div",{class:"card-divider-vertical"},null,-1)),t("div",ue,[t("div",he,c(l.user_name),1)]),e[43]||(e[43]=t("div",{class:"card-divider-vertical"},null,-1)),t("div",De,[t("div",ge,c(l.user_role),1)])]),e[47]||(e[47]=k('<div class="card-row header-row-card" data-v-80936e85><div class="card-cell" data-v-80936e85><div class="cell-label" data-v-80936e85>Device</div></div><div class="card-divider-vertical" data-v-80936e85></div><div class="card-cell" data-v-80936e85><div class="cell-label" data-v-80936e85>Bay #</div></div><div class="card-divider-vertical" data-v-80936e85></div><div class="card-cell" data-v-80936e85><div class="cell-label" data-v-80936e85>Event</div></div></div>',1)),t("div",pe,[t("div",me,[t("div",ke,c(l.devices_id),1)]),e[44]||(e[44]=t("div",{class:"card-divider-vertical"},null,-1)),t("div",ye,[t("div",fe,c(l.cabinet_no),1)]),e[45]||(e[45]=t("div",{class:"card-divider-vertical"},null,-1)),t("div",be,[t("div",_e,c(l.event_name),1)])])]))),128))]),o.showUsersModal?(r(),d("div",we,[t("div",Ce,[t("div",Me,[e[48]||(e[48]=t("h3",null,"Select Users",-1)),t("button",{class:"close-btn",onClick:e[17]||(e[17]=l=>o.showUsersModal=!1)},"×")]),t("div",Le,[(r(!0),d(u,null,h(o.usersList,l=>(r(),d("div",{key:l.id,class:D(["grid-item",{selected:o.selectedUsers.some(v=>v.id===l.id)}]),onClick:v=>n.toggleSelection(o.selectedUsers,l)},c(l.name),11,Se))),128))]),t("div",Re,[t("button",{class:"modal-btn cancel",onClick:e[18]||(e[18]=l=>o.showUsersModal=!1)},"Cancel"),t("button",{class:"modal-btn confirm",onClick:e[19]||(e[19]=l=>{o.showUsersModal=!1,n.loadReportData()})},"Confirm")])])])):g("",!0),o.showDevicesModal?(r(),d("div",Ee,[t("div",Ue,[t("div",Be,[e[49]||(e[49]=t("h3",null,"Select Devices",-1)),t("button",{class:"close-btn",onClick:e[20]||(e[20]=l=>o.showDevicesModal=!1)},"×")]),t("div",Fe,[(r(!0),d(u,null,h(o.devicesList,l=>(r(),d("div",{key:l.id,class:D(["grid-item",{selected:o.selectedDevices.some(v=>v.id===l.id)}]),onClick:v=>n.toggleSelection(o.selectedDevices,l)},c(l.name),11,Ae))),128))]),t("div",Te,[t("button",{class:"modal-btn cancel",onClick:e[21]||(e[21]=l=>o.showDevicesModal=!1)},"Cancel"),t("button",{class:"modal-btn confirm",onClick:e[22]||(e[22]=l=>{o.showDevicesModal=!1,n.loadReportData()})},"Confirm")])])])):g("",!0),o.showLockersModal?(r(),d("div",xe,[t("div",Ie,[t("div",Oe,[e[50]||(e[50]=t("h3",null,"Select Lockers",-1)),t("button",{class:"close-btn",onClick:e[23]||(e[23]=l=>o.showLockersModal=!1)},"×")]),t("div",Pe,[(r(!0),d(u,null,h(o.lockersList,l=>(r(),d("div",{key:l.id,class:D(["grid-item",{selected:o.selectedLockers.some(v=>v.id===l.id)}]),onClick:v=>n.toggleSelection(o.selectedLockers,l)},c(l.name),11,Ye))),128))]),t("div",je,[t("button",{class:"modal-btn cancel",onClick:e[24]||(e[24]=l=>o.showLockersModal=!1)},"Cancel"),t("button",{class:"modal-btn confirm",onClick:e[25]||(e[25]=l=>{o.showLockersModal=!1,n.loadReportData()})},"Confirm")])])])):g("",!0),o.showBaysModal?(r(),d("div",Ne,[t("div",Ve,[t("div",qe,[o.selectedLockers.length>0?(r(),d("h3",ze," Select Bay Numbers ("+c(o.selectedLockers[0].name)+" - "+c(o.selectedLockers[0].bayTotal)+" Bays) ",1)):(r(),d("h3",He," Select Bay Numbers ")),t("button",{class:"close-btn",onClick:e[26]||(e[26]=l=>o.showBaysModal=!1)},"×")]),t("div",We,[(r(!0),d(u,null,h(o.baysList,l=>(r(),d("div",{key:l,class:D(["grid-item",{selected:o.selectedBays.includes(l)}]),onClick:v=>n.toggleSelection(o.selectedBays,l)},c(l),11,Je))),128))]),t("div",Qe,[t("button",{class:"modal-btn cancel",onClick:e[27]||(e[27]=l=>o.showBaysModal=!1)},"Cancel"),t("button",{class:"modal-btn confirm",onClick:e[28]||(e[28]=l=>{o.showBaysModal=!1,n.loadReportData()})},"Confirm")])])])):g("",!0)])}const tt=C(R,[["render",Ge],["__scopeId","data-v-80936e85"]]);export{tt as default};
