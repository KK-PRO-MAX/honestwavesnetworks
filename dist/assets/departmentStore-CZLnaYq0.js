import{Y as _,r as m,m as n}from"./index-COfldkwK.js";import{a as v}from"./index-B9ygI19o.js";const c=v.create({baseURL:"https://guiz.haomengwl.com/api",timeout:1e4,headers:{"Content-Type":"application/json"}});c.interceptors.request.use(e=>{var l;const s=localStorage.getItem("token");return s&&(e.headers.token=s),console.log("Group API 发送请求:",(l=e.method)==null?void 0:l.toUpperCase(),e.url),console.log("请求数据:",e.data),e},e=>(console.error("请求拦截器错误:",e),Promise.reject(e)));c.interceptors.response.use(e=>(console.log("Group API 收到响应:",e.status,e.data),e.data&&typeof e.data=="object"&&(e.data.ret!==void 0&&console.log("  ✓ ret:",e.data.ret),e.data.code!==void 0&&console.log("  ✓ code:",e.data.code),e.data.msg!==void 0&&console.log("  ✓ msg:",e.data.msg),e.data.ret_data!==void 0&&(console.log("  ✓ ret_data 类型:",Array.isArray(e.data.ret_data)?"Array":typeof e.data.ret_data),Array.isArray(e.data.ret_data)&&console.log("    数据数量:",e.data.ret_data.length))),e),e=>(console.error("Group API 响应错误:",e.message||e),e.response?(console.error("  HTTP 状态码:",e.response.status),console.error("  响应数据:",e.response.data)):e.request?console.error("  没有接收到响应"):console.error("  请求错误:",e.message),Promise.reject(e)));function w(){return c.post("/Group/group_list")}function h(e){return c.post("/Group/add_group",e)}function k(e){return c.post("/Group/edit_group",e)}function A(e){return c.post("/Group/del_group",e)}const G=_("department",()=>{const e=m([]),s=m(!1),l=m(null),i=async()=>{s.value=!0,l.value=null;try{console.log("开始加载部门列表...");const t=await w();if(console.log("API 响应:",t),t&&t.data){const o=t.data;if(console.log("响应数据结构:",o),o.ret===0||o.code===200||o.code==="200"){let r=o.ret_data;if(typeof r=="string")try{r=JSON.parse(r)}catch(a){throw console.error("解析部门数据失败:",a),new Error("数据格式错误")}return r&&Array.isArray(r)?(e.value=r.map(a=>({id:a.id,name:a.group_name,locker:a.locker_name,locker_id:parseInt(a.locker_id)||0,assignedBays:a.bay_list,devices:a.bay_total.toString(),category:"A1",user_list:a.user_list,detail:a.detail,expanded:!1})),console.log("✓ 部门列表加载成功，共",e.value.length,"条记录"),e.value):(console.warn("⚠ API 返回格式异常，使用本地演示数据"),e.value=u(),e.value)}else throw new Error(o.msg||`API 错误：${o.code}`)}else throw new Error("无效的 API 响应")}catch(t){const o=t instanceof Error?t.message:"获取部门列表失败";return l.value=o,console.error("✗ 部门列表加载失败:",o,t),console.log("✓ 使用本地演示数据"),e.value=u(),t instanceof Error&&(t.message.includes("Network")||t.message.includes("timeout"))&&n.warning("网络连接失败，显示本地数据"),e.value}finally{s.value=!1}},g=async t=>{var o;s.value=!0,l.value=null;try{const r={group_name:t.name,detail:t.detail||"",locker_id:t.locker_id||0,user_list:t.user_list||"",bay_list:t.assignedBays||""},a=await h(r);if(a.data&&a.data.ret===0)return n.success("Department added successfully"),await i(),a.data.ret_data;throw new Error(((o=a.data)==null?void 0:o.msg)||"Failed to add department")}catch(r){const a=r instanceof Error?r.message:"Failed to add department";throw l.value=a,n.error(a),console.error("添加部门出错:",r),r}finally{s.value=!1}},p=async t=>{var o;s.value=!0,l.value=null;try{const r={id:t.id,group_name:t.name,detail:t.detail||"",locker_id:t.locker_id||0,user_list:t.user_list||"",bay_list:t.assignedBays||""},a=await k(r);if(a.data&&(a.data.ret===0||a.data.code===200||a.data.code==="200"))return n.success("Department edited successfully"),await i(),a.data.ret_data;throw new Error(((o=a.data)==null?void 0:o.msg)||"Failed to edit department")}catch(r){const a=r instanceof Error?r.message:"Failed to edit department";throw l.value=a,n.error(a),console.error("编辑部门出错:",r),r}finally{s.value=!1}},f=(t,o)=>{t>=0&&t<e.value.length&&(e.value[t]={...e.value[t],...o})},y=async t=>{var o;s.value=!0,l.value=null;try{const r=e.value[t];if(!r)throw new Error("部门不存在");const a={id:r.id},d=await A(a);if(d.data&&(d.data.ret===0||d.data.code===200||d.data.code==="200"))return n.success("Department deleted successfully"),e.value.splice(t,1),d.data.ret_data;throw new Error(((o=d.data)==null?void 0:o.msg)||"删除部门失败")}catch(r){const a=r instanceof Error?r.message:"删除部门失败";throw l.value=a,n.error(a),console.error("删除部门出错:",r),r}finally{s.value=!1}},u=()=>[{id:1,name:"Engineering",locker:"Locker A",locker_id:1,assignedBays:"1, 2, 3, 4, 5",devices:"12",category:"A1",user_list:"1,2,3",detail:"Engineering department",expanded:!1},{id:2,name:"Marketing",locker:"Locker B",locker_id:2,assignedBays:"6, 7, 8, 9, 10",devices:"8",category:"A2",user_list:"4,5,6",detail:"Marketing department",expanded:!1},{id:3,name:"Sales",locker:"Locker C",locker_id:3,assignedBays:"11, 12, 13, 14, 15",devices:"15",category:"A3",user_list:"7,8,9",detail:"Sales department",expanded:!1}];return{departments:e,loading:s,error:l,loadDepartments:i,addDepartment:g,editDepartment:p,deleteDepartment:y,updateDepartment:f,getLocalDemoData:u}});export{G as u};
